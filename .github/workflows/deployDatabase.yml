name: Deploy Database Models with Liquibase

on:
  push:
    branches: [ main ]
    paths:
      - '*.sql'
  workflow_dispatch:
    inputs:
      models:
        description: 'Models to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - modelo01
          - modelo02
          - modelo03

env:
  SQL_SERVER: 'serverlab03.database.windows.net'
  SQL_USER: 'fabiola'
  LIQUIBASE_VERSION: '4.25.1'

jobs:
  deploy-models:
    name: Deploy SQL Models with Liquibase
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Setup Java for Liquibase
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Download Liquibase
      run: |
        wget https://github.com/liquibase/liquibase/releases/download/v${{ env.LIQUIBASE_VERSION }}/liquibase-${{ env.LIQUIBASE_VERSION }}.tar.gz
        tar -xzf liquibase-${{ env.LIQUIBASE_VERSION }}.tar.gz
        chmod +x liquibase

    - name: Download SQL Server JDBC Driver
      run: |
        wget https://download.microsoft.com/download/8/6/8/868e5fc4-7bfe-494d-8f9d-115cbcdb52ae/sqljdbc_12.4.2.0_enu.tar.gz
        tar -xzf sqljdbc_12.4.2.0_enu.tar.gz

    - name: Deploy Modelo01 with Liquibase
      if: github.event.inputs.models == 'all' || github.event.inputs.models == 'modelo01' || github.event.inputs.models == ''
      run: |
        echo "üöÄ Deploying modelo01.sql to modelo01_envios using Liquibase..."
        ./liquibase \
          --driver=com.microsoft.sqlserver.jdbc.SQLServerDriver \
          --classpath=sqljdbc_12.4/enu/mssql-jdbc-12.4.2.jre11.jar \
          --changeLogFile=modelo01.sql \
          --url="jdbc:sqlserver://$SQL_SERVER:1433;database=modelo01_envios;encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30;" \
          --username=$SQL_USER \
          --password="${{ secrets.SQL_ADMIN_PASSWORD }}" \
          update
        echo "‚úÖ Modelo01 deployed successfully with Liquibase!"

    - name: Deploy Modelo02 with Liquibase
      if: github.event.inputs.models == 'all' || github.event.inputs.models == 'modelo02' || github.event.inputs.models == ''
      run: |
        echo "üöÄ Deploying modelo02.sql to modelo02_reservas using Liquibase..."
        ./liquibase \
          --driver=com.microsoft.sqlserver.jdbc.SQLServerDriver \
          --classpath=sqljdbc_12.4/enu/mssql-jdbc-12.4.2.jre11.jar \
          --changeLogFile=modelo02.sql \
          --url="jdbc:sqlserver://$SQL_SERVER:1433;database=modelo02_reservas;encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30;" \
          --username=$SQL_USER \
          --password="${{ secrets.SQL_ADMIN_PASSWORD }}" \
          update
        echo "‚úÖ Modelo02 deployed successfully with Liquibase!"

    - name: Deploy Modelo03 with Liquibase
      if: github.event.inputs.models == 'all' || github.event.inputs.models == 'modelo03' || github.event.inputs.models == ''
      run: |
        echo "üöÄ Deploying modelo03.sql to modelo03_adicional using Liquibase..."
        ./liquibase \
          --driver=com.microsoft.sqlserver.jdbc.SQLServerDriver \
          --classpath=sqljdbc_12.4/enu/mssql-jdbc-12.4.2.jre11.jar \
          --changeLogFile=modelo03.sql \
          --url="jdbc:sqlserver://$SQL_SERVER:1433;database=modelo03_adicional;encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30;" \
          --username=$SQL_USER \
          --password="${{ secrets.SQL_ADMIN_PASSWORD }}" \
          update
        echo "‚úÖ Modelo03 deployed successfully with Liquibase!"

    - name: Deployment Summary
      run: |
        echo "üéâ Database models deployment completed with Liquibase!"
        echo "üìä Models deployed to:"
        echo "  - modelo01_envios (Shipping model)"
        echo "  - modelo02_reservas (Travel reservations model)" 
        echo "  - modelo03_adicional (Additional model)"
        echo "üîó Server: $SQL_SERVER"
        echo "üõ†Ô∏è Tool: Liquibase v${{ env.LIQUIBASE_VERSION }}"